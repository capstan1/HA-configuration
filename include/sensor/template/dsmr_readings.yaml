platform: template
sensors:
  # CORRECTION YEARLY WATER
  yearly_water_corrected:
    friendly_name: "Waterverbruik gecorrigeerd"
    unit_of_measurement: m3
    value_template: >
      {%- if now().year | int(0)== 2021 %}
        {{ (states('sensor.yearly_water') | float(0) / 1000 + (0.341 * 81)) | round(2) }} 
      {%- else %}
        {{ (states('sensor.yearly_gas') | float(0) / 1000) | round(2) }}
      {%- endif %}
  # LAST PERIODS WATER
  yesterday_water:
    friendly_name: "Waterverbruik gisteren"
    unit_of_measurement: L
    value_template: "{{ state_attr('sensor.daily_water','last_period') }}"
  last_week_water:
    friendly_name: "Waterverbruik vorige week"
    unit_of_measurement: L
    value_template: "{{ state_attr('sensor.weekly_water','last_period') }}"
  last_month_water:
    friendly_name: "Waterverbruik vorige maand"
    unit_of_measurement: L
    value_template: "{{ state_attr('sensor.monthly_water','last_period') }}"
  last_year_water:
    friendly_name: "Waterverbruik vorig jaar"
    unit_of_measurement: m3
    value_template: >
      {%- if now().year | int(0)== 2021 %}
        {{ 124 }}
      {%- elif now().year | int(0)== 2022 %}
        {{ (state_attr('sensor.yearly_water','last_period') | float(0) / 1000 + (0.341 * 81)) | round(2) }}
      {%- else %}
        {{ (state_attr('sensor.yearly_water','last_period') | float(0) / 1000) | round(2)  }}
      {%- endif %}
  # CALCULATIONS
  meter_water:
    friendly_name: "Meterstand water"
    unit_of_measurement: m3
    value_template: "{{ (states('input_number.correction_water_meter') | float(0) + (states('sensor.yearly_water') | float(0) /1000))|round(3) }}"
  days_last_month:
    friendly_name: "Aantal dagen vorige maand"
    unit_of_measurement: "dagen"
    value_template: >
      {%- if now().month -1 in [0,1,3,5,7,8,10] %}
        31
      {%- elif now().month -1 in [4,6,9,11] %}
        30
      {%- elif now().month -1 == 2 and ((now().year-2000) % 4 > 0) %}
        28
      {%- elif now().month -1 == 2 and ((now().year-2000) % 4 == 0) %}
        29
      {%- endif %}
  #Gemiddeld water deze maand
  average_water_day:
    unit_of_measurement: "L"
    value_template: >
      {%- if now().day | int(0)== 1 %}
        {{ states('sensor.monthly_water') | float(0) | round(3) }}
      {%- else %}
        {{ (( states('sensor.monthly_water') | float(0) - states('sensor.daily_water') | float(0) ) / ( now().day | int(0)- 1 )) | round(3) }}
      {%- endif %}
